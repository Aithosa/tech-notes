# 注入攻击类排查

## 一、攻击类型分类

### 1. 注入类攻击

- SQL 注入
- 命令注入
- XXE (XML 实体) 注入
- Freemarker 模板注入
- EL 表达式注入

### 2. 文件操作类攻击

- 任意文件上传
- 任意文件下载
- Excel/CSV 文件 DDE 攻击

### 3. 其他类型攻击

- 正则表达式攻击（ReDoS）
- SQL 查询条件校验不严(CodeX 检查出来过)

## 二、详细排查方法

```text
已知清单：
1.2 脚本命令注入
1.3 Freemarker 模板注入
1.4 任意文件下载
1.6 XXE(XML 实体)注入
1.7 正则表达式攻击
1.9 SQL 查询条件未严格校验
1.7 Excel/CSV 文件，DDE 攻击
1.8 EL 表达式注入
```

### 脚本命令注入

以外部输入作为部分或全部脚本路径、脚本内容，进行命令执行的。

尤其是通过 `new String[]{“sh”, “-c”, “script par1 par2 par3”}`这种方式执行的时候，只要任何一个参数中有`;`，都可以在后面执行任意其他命令。

排查方法：代码搜索所有`.getRuntime().exec(`或`.exec(`或 `ProcessBuilder`，分析是否是脚本调用。
注：初步排查数据组有这个问题，交通组没有搜到关键词。

### Freemarker 模板注入

Freemarker 模板引擎与 EL 表达式类似，功能比较强大，支持在模板中执行 JAVA 代码、调用外部程序。此功能默认是没有关闭的，如果支持使用用户提交的模板，则用户可以在模板中构造特殊语句调用外部程序。

排查方法：搜索 Freemarker，结合接口和业务功能进行排查

<!-- 注：air-ticketing 上有一个，已整改：TRAFFIC-820 Freemarker 安全问题整改，禁用所有外部类解析和?api 调用 -->

### 任意文件下载

下载接口直接拿用户的输入拼接文件路径，没有对要输入进行校验和限制，导致可以通过相对路径方式下载任意目录的文件。

排查方法：

- 搜索 `new File`、`new FileInputStream`、`download`、`FastDFS`、`NFS` 等关键字。
- 搜索所有文件上传下载接口

注：需要关注下，使用场景很多

### XXE(XML 实体)注入

使用 XML 解析器，解析外部人输入的 XML 时，没有禁用 XML 实体处理，导致外部可以在 XML 中构造特殊内容，让解析器访问特定网址下载文件等。

整改方法：`Itrdk V2.1` 和 `V3.0` 版本中，提供了两个可以获取安全 XML 解析器的函数：`(ConfUtil.java)：ConfUtil.getSecurityXmlDocumentFactory()`。使用 XML 解析器时，进来采用上述两个函数获取解析器，或参考进行类似编码设置。

排查方法：搜索所有使用 `DocumentBuilderFactory`、`SAXParserFactory`、`JAXBContext`、`Unmarshaller`。

注：这个问题之前应该没改过，文档里列举的有问题的代码还在。

### 正则表达式攻击

分为两类，一类是正则注入，会导致信息泄露；一类是正则攻击 Redos，会导致拒绝服务。

排查方法：使用`.split`、`Pattern`、`@Pattern`、`Pattern.`、`.matches`、`.replaceAll`、`.replaceFirst`、`.matcher` 等关键字进行搜索，然后借助工具分析是否存在问题。

<!-- SDL Regex Fuzzer：http://3ms.huawei.com/km/blogs/details/6056857 -->

排查方法：搜索关键词，找到正则表达式，用工具（SDL Regex Fuzzer）检测。

### SQL 查询条件未严格校验

- 查询支持分页，但分页大小未做限制
- 界面要求输入条件，但实际后台接口可以所有条件为空进行查询(这个问题应该存在)

整改方法：

- 对分页大小进行限制，一般单次返回不允许超过 500 条
- 根据业务和接口规则，输入条件进行限制，保证前端和后台的校验规则一致。如果一个接口分别有两种用途和校验规则，建议区分调用方或使用不同的 Controller 对不同面开放不同的配置，校验规则也不相同。
- 除非特殊命名的 SQL（如 SelectAll、FindAll），其他 SQL 不允许支持最后构造的结果为 select _ from xx，不带 where 条件。

排查：

- `select _`：注意条件都失效的情况(不是 `select \*` 但是 where 条件会失效/无 where，考虑目的就是查全部，带分页)
- 分页有两种限制，一是直接在字段上限制，但是注意校验是不是生效；二是在代码里限制

注：

- 像是管理接口，本身条件为空设计上就希望查全部数据，要求是要分页就行？
- 非管理接口，如果查询条件都为空(在 mapper 层)，但是有 limit 1(尤其看下 mbatis)

### 接口存在 SQL 注入

SQL 注入是指 SQL 查询被恶意更改成一个与程序预期完全不同的查询。执行更改后的查询可能会导致信息泄露或者数据被篡改。而 SQL 注入的根源就是使用外部数据来拼接 SQL 语句。

- 参数化查询是一种简单有效的防止 SQL 注入的查询方式，应该被优先考虑使用。另外，参数化查询还能提高数据库访问的性能。
- Java 工程排查数据库 SQL 的 `Mapper.xml` 文件中是否存在${XXX}格式的绑定参数，修改为`#{XXX}`。

排查方法：

- 搜索`${XXX}`
- JPA：禁止直接使用不可信数据来拼接 SQL 语句：`createNativeQuery()`、`@Query(`，关注下拼接 SQL

### Excel/CSV 文件，DDE 攻击

表格中的数据如果是不可信数据，攻击者可以构造以`=`、`+`、`-`或`@`开头的命令，受害者采用 Excel 打开电子表格文件时就会执行构造的命令或函数，导致命令注入风险的产生。电子表格文件包括`.xlsx`、`.xls`、`.xlsm`、`.csv`、`.xlsb`、`.xlam` 等后缀格式的文件。

整改方法:

- 规则 8.5.1 导出或下载电子表格文件时，禁止单元格内容直接以“=”“+”“-”或“@”开头，如果需要以这些特殊字符开头，要进行转义处理

说明：导出或下载的电子表格文件内容如果为可信内容则无需关注此规则，不可信的内容导出或下载到电子表格文件才需做防范处理。

修改方法：
由于 `cell.setCellType` 已经是废弃的，即将在 poi 5 版本移除，因此，建议直接在创建 cell 时指定类型，除非特殊需要，否则都要设置为：
`Cell cell = row.createCell(cellnum, CellType.STRING);`
使用 HSSF 和 XSSF，优先使用上述方式，同时结合字符串过滤。

CSV 文件，如果存在换行，则必须把值放在两个双引号""内，如果其中还出现了双引号"，则每个双引号"要使用两个""替换。判断值是否有`=`、`+`、`-`、`"`、`@`和回车换行(`\r`、`\n`)，如果有则必须进行编码，参考 itrdk 中的 `StrUtil.csvEncoding`、
`setCellStyle(textStyle);`、 `setCellType(CellType.STRING);`

### EL 表达式注入

所有使用 itrdk 中`@ValuePool` 校验的工程。

测试方法：在接口测试时，对于任一参数，都建议使用`${1+1}`、`{‘’.getClass()}`、`${‘’.getClass}`这类的值进行测试，以检测是否会有表达式注入风险。同时可以在接口中，增加参数`@type`、`@class` 进行验证，避免反射类（类似 fastjson）问题。

修改方法：在代码中搜索`@ValuePool`，凡是使用此注解的工程，都需要重新构建发布。

同类分析：关注下

注：使用较多，需要确认后端是否需要排查。后端使用的是 itrdk 的注解，重新用最新版本编译就可以了

## 三、安全加固建议

1. 输入验证

   - 实施严格的输入验证
   - 使用白名单方式验证
   - 统一验证框架

2. 参数化查询

   - 使用预编译 SQL
   - 避免动态 SQL 拼接
   - 合理使用 ORM 框架

3. 权限控制

   - 最小权限原则
   - 合理的访问控制
   - 敏感操作审计

4. 配置安全

   - 禁用危险特性
   - 合理配置超时时间
   - 启用安全选项

## 四、排查清单

- [x] 脚本命令注入 - 已排查
- [x] Freemarker 模板注入 - 已排查
- [x] 正则表达式攻击 - 已排查
- [x] 接口存在 Sql 注入 - 已排查，看下 JPA 拼接 SQL
- [x] SQL 查询条件未严格校验 - 已排查
- [x] Excel/CSV 文件，DDE 攻击- 已排查
- [x] 任意文件下载- 已排查
- [x] XXE(XML 实体)注入 - 已排查
